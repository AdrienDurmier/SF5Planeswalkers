{% extends 'game.html.twig' %}
{% import 'macro/avatar.html.twig' as avatar %}

{% block title "Games" %}

{% block body %}

    {# ZONE DE JEU #}
    <div id="game-main-area">
        {# Opponent area #}
        <div id="opponent-area" class="player-area player-area-{{ opponent.id }}" data-player="{{ opponent.id }}">
            <div class="avatar-area">
                <div id="opponent-lifepoint" class="lifepoint" title="Lifepoints">20</div>
                {{ avatar.afficher(opponent.user) }}
            </div>
            <div class="row-library-hand">
                <div class="exile" title="Exile">
                    <div id="opponent-exile-top-card" class="exile-top-card"></div>
                </div>
                <div class="graveyard" title="Graveyard">
                    <div id="opponent-graveyard-top-card" class="graveyard-top-card"></div>
                </div>
                <div class="library" title="Library">
                    <div id="opponent-library-top-card" class="library-top-card"></div>
                </div>
                <div class="hand"></div>
            </div>
            <div class="row-zone-battlefield">
                <div class="battlefield"></div>
            </div>
        </div>
        {# Allies area #}
        <div id="player-area" class="player-area player-area-{{ player.id }}" data-player="{{ player.id }}">
            <div class="avatar-area">
                <div id="player-lifepoint" class="lifepoint" title="Lifepoints">20</div>
                {{ avatar.afficher(player.user) }}
            </div>
            <div class="row-zone-battlefield">
                <div data-area="battlefield" class="battlefield" data-player="{{ player.id }}"></div>
            </div>
            <div class="row-library-hand">
                <div data-area="exile" class="exile" title="Exile">
                    <div id="player-exile-top-card" class="exile-top-card" data-area="exile" draggable="true" data-player="{{ player.id }}"></div>
                </div>
                <div data-area="graveyard" class="graveyard" title="Graveyard">
                    <div id="player-graveyard-top-card" class="graveyard-top-card" data-area="graveyard" draggable="true" data-player="{{ player.id }}"></div>
                </div>
                <div data-area="library" class="library" title="Library">
                    <div id="player-library-top-card" class="library-top-card" data-area="library" draggable="true" data-player="{{ player.id }}"></div>
                </div>
                <div data-area="hand" class="hand"></div>
            </div>
        </div>
    </div>

    {# ZONE SIDEBAR #}
    <div id="game-sidebar-area">
        {# Zones contenants les messages #}
        <div id="tchat-messages-area" class="tchat-messages-content">
        </div>
        {# Zone de rédaction des messages #}
        <div id="tchat-rediger-area">
            <div id="tchat-message-contenu-area" class="flex-grow-1">
                <div class="form-group">
                    <input type="text" class="form-control" id="tchat-message-input" name="content">
                </div>
            </div>
        </div>
    </div>


    {# Modale : détails d'une carte #}
    {% import 'admin/planeswalkers/play/rendu/card-details.html.twig' as cardDetails %}
    {{ cardDetails.afficher() }}

    {# Menu contextual #}
    <div id="menu-contextual" class="menu"></div>

{% endblock %}

{% block javascripts %}
    <script>
        {# Draggable #}
        let grid = 15;
        let draggableELement = null;
        $("body").on("drag", '.exile-top-card, .graveyard-top-card, .library-top-card, .hand-card-link, .battlefield-card-link', function(e) {
            e.preventDefault();
            e.stopPropagation();
            draggableELement = $(this);
        });
        $("body").on("dragover", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).addClass('dragging');
        });
        $("body").on("dragleave", function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).removeClass('dragging');
        });

        {# Chargement de la partie #}
        $(document).ready(function() {
            {# Chargement du jeu du joueur #}
            let areasPlayer = JSON.parse('{{ areasPlayer|raw }}');
            let playerArea = $('.player-area-{{ player.id }}');
            renderExile(areasPlayer, playerArea);
            renderLibrary(areasPlayer, playerArea);
            renderGraveyard(areasPlayer, playerArea);
            renderHand(areasPlayer, playerArea);
            renderBattlefield(areasPlayer, playerArea);
            {# Chargement du jeu de l'adversaire #}
            let areasOpponent = JSON.parse('{{ areasOpponent|raw }}');
            let opponentArea = $('.player-area-{{ opponent.id }}');
            renderExile(areasOpponent, opponentArea);
            renderLibrary(areasOpponent, opponentArea);
            renderGraveyard(areasOpponent, opponentArea);
            renderHand(areasOpponent, opponentArea);
            renderBattlefield(areasOpponent, opponentArea);

            {# Lancer de dé pour déterminer qui commence #}
            {# Préparation des phases #}

            {# Les joueurs pioches 7 cartes #}

            {# Mulligan éventuel #}

            {# Début de la partie #}

        });

        {# Mercure #}
        const url = new URL('{{mercure_publish_url}}');
        url.searchParams.append('topic', 'planeswalkers-game-'+ {{ game.id }} );
        const eventSource = new EventSource(url);
        eventSource.onmessage = event => {
            let retourMercure = JSON.parse(event.data);
            let player_area = $('.player-area-' + retourMercure.player);

            {# Mise à jour des zones de jeu liées à l'action #}
            if (typeof retourMercure.move !== 'undefined'){
                if (retourMercure.move.from === 'exile' || retourMercure.move.to === 'exile'){
                    renderExile(retourMercure.areas, player_area);
                }
                if (retourMercure.move.from === 'library' || retourMercure.move.to === 'library'){
                    renderLibrary(retourMercure.areas, player_area);
                }
                if (retourMercure.move.from === 'graveyard' || retourMercure.move.to === 'graveyard'){
                    renderGraveyard(retourMercure.areas, player_area);
                }
                if (retourMercure.move.from === 'hand' || retourMercure.move.to === 'hand'){
                    renderHand(retourMercure.areas, player_area);
                }
                if (retourMercure.move.from === 'battlefield' || retourMercure.move.to === 'battlefield'){
                    renderBattlefield(retourMercure.areas, player_area);
                }
            }

            {# Logs #}
            if (retourMercure.log){
                renderLog(retourMercure);
            }

            {# Messages #}
            if (retourMercure.message){
                renderMessage(retourMercure);
            }
        }
    </script>

    {# Rendu #}
    {{ avatar.script() }}
    {% import 'admin/planeswalkers/play/action/card-details.html.twig' as cardDetailsJs %}
    {{ cardDetailsJs.script() }}
    {% import 'admin/planeswalkers/play/rendu/exile.html.twig' as exileJs %}
    {{ exileJs.script() }}
    {% import 'admin/planeswalkers/play/rendu/graveyard.html.twig' as graveyardJs %}
    {{ graveyardJs.script() }}
    {% import 'admin/planeswalkers/play/rendu/library.html.twig' as libraryJs %}
    {{ libraryJs.script(game) }}
    {% import 'admin/planeswalkers/play/rendu/hand.html.twig' as handJs %}
    {{ handJs.script() }}
    {% import 'admin/planeswalkers/play/rendu/battlefield.html.twig' as battlefieldJs %}
    {{ battlefieldJs.script() }}
    {% import 'admin/planeswalkers/play/rendu/message.html.twig' as messageJs %}
    {{ messageJs.script(player) }}

    {# Raccourcies clavier #}
    {% import 'admin/planeswalkers/play/action/keyboard-shortcuts.html.twig' as actionKeyboardShortcutsJs %}
    {{ actionKeyboardShortcutsJs.script() }}

    {# Menu contextuel #}
    {% import 'admin/planeswalkers/play/action/menu-contextual.html.twig' as actionMenuContextualJs %}
    {{ actionMenuContextualJs.script() }}

    {# Move #}
    {% import 'admin/planeswalkers/play/action/move.html.twig' as actionMoveJs %}
    {{ actionMoveJs.script(game) }}

    {# Draw #}
    {% import 'admin/planeswalkers/play/action/draw.html.twig' as actionDrawJs %}
    {{ actionDrawJs.script(game) }}


{% endblock %}