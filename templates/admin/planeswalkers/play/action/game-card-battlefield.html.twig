{% macro script(game) %}
    <script>
        let clicksBattlefield = 0, timerBattlefield = null;

        $(document).on('click', '.battlefield-card-link', function(e) {
            clicksBattlefield++;
            {# Pour un clic on ouvre les détails de la carte #}
            if(clicksBattlefield === 1) {
                timerBattlefield = setTimeout(function() {
                    clicksBattlefield = 0;
                    $('#cardDetailsModal').modal('show');
                }, 200);
            }
            {# Pour un double-clic on déplace la carte sur le champs de bataile #}
            else {
                clearTimeout(timerBattlefield);
                clicksBattlefield = 0;
                let player = $('#player-area').data('player');
                let card = $(this).data('id');
                if ($(this).hasClass('tapped')){
                    launchUntapped(player, card);
                }else{
                    launchTapped(player, card);
                }
            }
        });

        {# Annulation du double-clic classique pour ne pas le cumuler avec l'event du simple clic #}
        $(document).on('dblclick', '.battlefield-card-link', function(e) {
            e.preventDefault();
        });

        {# Engager une carte depuis le menu contextuel #}
        $('#menu-contextual').on('click', '.tapped-link', function() {
            let player = $(this).data('player');
            let card = $(this).data('id');
            launchTapped(player, card);
        });
        function launchTapped(player, card){
            let parametres = {
                game: {{ game.id }},
                player: player,
                card: card,
                tapped: true,
            };
            $.ajax({
                url: "{{ path('planeswalkers.play.gamecardbattlefield.edit') }}",
                type: 'post',
                data: parametres,
                dataType: 'json'
            });
        }

        {# Dégager une carte depuis le menu contextuel #}
        $('#menu-contextual').on('click', '.untapped-link', function() {
            let player = $(this).data('player');
            let card = $(this).data('id');
            launchUntapped(player, card);
        });
        function launchUntapped(player, card){
            let parametres = {
                game: {{ game.id }},
                player: player,
                card: card,
                tapped: false,
            };
            $.ajax({
                url: "{{ path('planeswalkers.play.gamecardbattlefield.edit') }}",
                type: 'post',
                data: parametres,
                dataType: 'json'
            });
        }

        {# Clone une carte depuis le menu contextuel #}
        $('#menu-contextual').on('click', '.clone-link', function() {
            let player = $(this).data('player');
            let card = $(this).data('id');
            launchClone(player, card);
        });
        function launchClone(player, card){
            let parametres = {
                game: {{ game.id }},
                player: player,
                card: card
            };
            $.ajax({
                url: "{{ path('planeswalkers.play.gamecardbattlefield.clone') }}",
                type: 'post',
                data: parametres,
                dataType: 'json'
            });
        }

        {# Flip une carte depuis le menu contextuel #}
        $('#menu-contextual').on('click', '.facedown-link', function() {
            let player = $(this).data('player');
            let card = $(this).data('id');
            let faceDown = true;
            if ($('#battlefield-card-'+card).hasClass('faceDown')){
                faceDown = false;
            }
            launchFaceDown(player, card, faceDown);
        });
        function launchFaceDown(player, card, faceDown){
            let parametres = {
                game: {{ game.id }},
                player: player,
                card: card,
                faceDown: faceDown,
            };
            $.ajax({
                url: "{{ path('planeswalkers.play.gamecardbattlefield.edit') }}",
                type: 'post',
                data: parametres,
                dataType: 'json'
            });
        }

        {# Note sur une carte depuis le menu contextuel #}
        $('#menu-contextual').on('click', '.note-link', function() {
            $('#game-card-battlefield-note').val('');
            $('#cardNoteModal').modal('show');
            let player = $(this).data('player');
            let card = $(this).data('id');
            $('#game-card-battlefield-note-player').val(player);
            $('#game-card-battlefield-note-card').val(card);
        });
        $(document).on('click', '#cardNoteModalOK', function() {
            let player  = $('#game-card-battlefield-note-player').val();
            let card    = $('#game-card-battlefield-note-card').val();
            let note    = $('#game-card-battlefield-note').val();
            launchNote(player, card, note);
        });
        function launchNote(player, card, note){
            let parametres = {
                game: {{ game.id }},
                player: player,
                card: card,
                note: note,
            };
            $.ajax({
                url: "{{ path('planeswalkers.play.gamecardbattlefield.edit') }}",
                type: 'post',
                data: parametres,
                dataType: 'json'
            });
        }
    </script>
{% endmacro %}